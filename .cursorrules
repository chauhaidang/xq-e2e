# E2E Test Healing Rules

When an E2E test fails, follow this automated healing process:

## Test Failure Healing Workflow

1. **Capture DOM Tree Snapshot**
   - When a test fails, automatically capture the page source (DOM tree) at the point of failure
   - The page source should be printed/logged in the test output for analysis
   - Use the `printPageSource()` method from the base Page class to capture the current state

2. **Analyze the Failure**
   - Examine the error message to identify which element selector failed
   - Review the captured DOM tree to find the correct accessibility identifier or selector
   - Look for elements with `name` or `label` attributes that match the expected functionality
   - Check for common patterns:
     - Accessibility identifiers (e.g., `name="routine-name-input"`)
     - Element types (XCUIElementTypeTextField, XCUIElementTypeButton, etc.)
     - Text content that might be used for identification

3. **Fix the Selector**
   - Update the page object file with the correct selector
   - Prefer accessibility identifiers (`~identifier`) over XPath when possible
   - If an accessibility identifier doesn't exist, use XPath as a fallback
   - Ensure the selector matches the actual element structure in the DOM tree

4. **Rerun the Test**
   - After fixing the selector, automatically rerun the failing test
   - Verify that the fix resolves the issue
   - If the test still fails, repeat the process for the next failure point

## Implementation Guidelines

- **Page Objects**: All selectors should be defined in page object classes
- **Accessibility First**: Always prefer accessibility identifiers for better test stability
- **Error Handling**: Implement try-catch blocks for optional elements (like popups that may or may not appear)
- **Wait Strategies**: Use appropriate wait strategies (toBeDisplayed, waitForExist) with reasonable timeouts
- **DOM Analysis**: When analyzing DOM trees, look for:
  - `name` attribute (accessibility identifier)
  - `label` attribute (accessibility label)
  - `type` attribute (element type)
  - `value` attribute (current value)
  - `visible` and `accessible` attributes (element visibility)

## Example Healing Process

1. Test fails with: `Can't call click on element with selector "~Create Routine" because element wasn't found`
2. Capture DOM tree and find: `<XCUIElementTypeOther name="create-routine-button" .../>`
3. Fix selector: Change `$('~Create Routine')` to `$('~create-routine-button')`
4. Rerun test to verify fix

## Best Practices

- Always verify fixes by rerunning the test
- Document selector changes in code comments when the reason isn't obvious
- Keep selectors as specific as possible to avoid false matches
- Use meaningful accessibility identifiers in the app code to make tests more maintainable

